# docker-compose run ttex bash

services:

  tabrepo:
    container_name: tabrepo
    env_file: .env
    image: taisrc/tabrepo
    build:
        context: ../deps/
        dockerfile: ../docker/Dockerfile_tabrepo
        shm_size: '4gb'
        args:
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
        cache_from:
            - taisrc/tabrepo
            - type=registry,ref=taisrc/tabrepo:latest
    shm_size: '16gb'

  jaix_hpo:
    container_name: jaix_hpo
    env_file: .env
    image: taisrc/jaix_hpo${VER:+:}${VER}
    build:
        context: ..
        dockerfile: docker/Dockerfile_hpo
        args:
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
        cache_from:
            - taisrc/jaix_hpo
            - type=registry,ref=taisrc/jaix_hpo:latest
            - taisrc/jaix
            - type=registry,ref=taisrc/jaix:latest
            - taisrc/tabrepo
            - type=registry,ref=taisrc/tabrepo:latest
    volumes:
      - ../jaix:/jaix
      - ../tests:/tests
      - ../experiments:/experiments
    shm_size: '16gb'

  jaix:
    container_name: jaix
    env_file: .env
    image: taisrc/jaix${VER:+:}${VER}
    build:
        context: ..
        dockerfile: docker/Dockerfile
        args:
            EXTRAS: ""
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
        cache_from:
            - taisrc/jaix
            - type=registry,ref=taisrc/jaix:latest
            - taisrc/jaix_base
            - type=registry,ref=taisrc/jaix_base:latest
    volumes:
      - ../jaix:/jaix
      - ../tests:/tests
      - ../experiments:/experiments
    shm_size: '16gb'

  jaix_base:
    container_name: jaix_base
    env_file: .env
    image: taisrc/jaix_base${VER:+:}${VER}
    build:
        context: ..
        dockerfile: docker/Dockerfile
        args:
            EXTRAS: ""
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
        target: jaix_base
        cache_from:
            - taisrc/jaix_base
            - type=registry,ref=taisrc/jaix_base:latest
    shm_size: '16gb'

  jaix_coco:
    container_name: jaix_coco
    env_file: .env
    image: taisrc/jaix_coco${VER:+:}${VER}
    build:
        context: ..
        dockerfile: docker/Dockerfile
        args:
            EXTRAS: "[coco]"
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
        cache_from:
            - taisrc/jaix_coco
            - type=registry,ref=taisrc/jaix_coco:latest
            - taisrc/jaix_base
            - type=registry,ref=taisrc/jaix_base:latest
    volumes:
      - ../jaix:/jaix
      - ../tests:/tests
      - ../experiments:/experiments
    shm_size: '16gb'
  
  jaix_ase:
    container_name: jaix_ase
    env_file: .env
    image: taisrc/jaix_ase${VER:+:}${VER}
    build:
        context: ..
        dockerfile: docker/Dockerfile_ase
        args:
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
        cache_from:
            - taisrc/jaix_ase
            - type=registry,ref=taisrc/jaix_ase:latest
            - taisrc/jaix_base
            - type=registry,ref=taisrc/jaix_base:latest
    volumes:
      - ../jaix:/jaix
      - ../tests:/tests
      - ../experiments:/experiments
    shm_size: '16gb'
    depends_on:
        - jaix_base
  
    
  wandb_launcher:
    container_name: wandb_launcher
    env_file: .env
    image: taisrc/wandb:launcher
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      
  wandb_job_jaix:
    container_name: wandb_job_jaix
    env_file: .env
    image: taisrc/wandb_job_jaix${VER:+:}${VER}
    build:
        context: ..
        dockerfile: docker/Dockerfile_job
        args:
            BUILDKIT_INLINE_CACHE: "1"  # to enable explicit caching
            IMAGE: "taisrc/jaix${VER:+:}${VER}"
        cache_from:
            - taisrc/jaix
            - type=registry,ref=taisrc/jaix:latest
            - taisrc/wandb_job_jaix
            - type=registry,ref=taisrc/wandb_job_jaix:latest
    volumes:
      - ../jaix:/jaix/jaix
      - ../tests:/jaix/tests
      - ../experiments:/experiments
    entrypoint: bash
